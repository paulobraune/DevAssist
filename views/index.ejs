<div class="container">
  <div class="dashboard">
    <div class="sidebar">
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-folder-open"></i> Arquivos Disponíveis</h2>
        </div>
        <div class="panel-body">
          <ul class="files-list">
            <% if(files.length === 0) { %>
              <li class="empty-state">
                <i class="fas fa-info-circle file-icon"></i>
                Nenhum arquivo encontrado.
              </li>
            <% } else { %>
              <% files.forEach(function(file) { %>
                <li>
                  <i class="fas fa-file-code file-icon"></i>
                  <a href="/file/<%= file %>"><%= file %></a>
                  <a href="/analyze/<%= file %>" class="btn btn-small" title="Analisar com IA">
                    <i class="fas fa-search"></i>
                  </a>
                </li>
              <% }); %>
            <% } %>
          </ul>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-cloud-upload-alt"></i> Upload de Arquivo</h2>
        </div>
        <div class="panel-body">
          <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
            <div class="form-group">
              <label for="file">Selecione um arquivo para análise:</label>
              <input type="file" name="file" id="file" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-secondary">
              <i class="fas fa-upload"></i> Enviar Arquivo
            </button>
          </form>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-info-circle"></i> Status da API</h2>
        </div>
        <div class="panel-body">
          <button id="testApiBtn" class="btn btn-small">
            <i class="fas fa-sync-alt"></i> Testar Conexão
          </button>
          <div id="apiStatus" class="mt-2 alert alert-info" style="margin-top: 10px; display: none;"></div>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-robot"></i> Chat com DevAssist GPT</h2>
        </div>
        <div class="panel-body">
          <div id="chatResponses" class="chat-container">
            <div class="messages-wrapper">
              <div class="message gpt-message">
                <strong>DevAssist GPT:</strong> Olá! Estou pronto para ajudar com seu desenvolvimento. Você pode enviar arquivos para análise ou fazer perguntas sobre programação.
              </div>
            </div>
          </div>
          <form id="chatForm">
            <div class="form-group">
              <textarea name="message" id="message" class="form-control" placeholder="Digite sua mensagem aqui..." required></textarea>
            </div>
            <button type="submit" class="btn">
              <i class="fas fa-paper-plane"></i> Enviar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<%- contentFor('script') %>
<script src="/js/main.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const testButton = document.getElementById('testApiBtn');
    if (testButton) {
      testButton.addEventListener('click', async function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
        
        const statusDiv = document.getElementById('apiStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = 'Testando conexão com a API...';
        statusDiv.className = 'mt-2 alert alert-info';
        
        try {
          const response = await fetch('/api/test-openai');
          const data = await response.json();
          
          if (data.success) {
            statusDiv.className = 'mt-2 alert alert-success';
            statusDiv.innerHTML = `<strong>Sucesso!</strong> ${data.message}`;
          } else {
            statusDiv.className = 'mt-2 alert alert-warning';
            statusDiv.innerHTML = `<strong>Falha:</strong> ${data.error}`;
          }
        } catch (error) {
          console.error('Erro ao testar API:', error);
          statusDiv.className = 'mt-2 alert alert-warning';
          statusDiv.innerHTML = `<strong>Erro:</strong> Falha na comunicação com o servidor: ${error.message}`;
        } finally {
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-sync-alt"></i> Testar Conexão';
        }
      });
    } else {
      console.error('Botão de teste não encontrado!');
    }
  });
</script>
